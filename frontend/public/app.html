<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PronunciaPA - Transcripci√≥n IPA</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <header class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">
        üé§ PronunciaPA
      </h1>
      <p class="text-gray-600">
        Transcripci√≥n de audio a notaci√≥n fon√©tica internacional (IPA)
      </p>
    </header>

    <!-- Main Card -->
    <div class="bg-white rounded-lg shadow-xl p-8">
      <!-- Audio Source Tabs -->
      <div class="mb-6">
        <div class="flex border-b border-gray-200">
          <button 
            id="tabFile"
            class="tab-button px-6 py-3 font-medium border-b-2 border-purple-600 text-purple-600"
            data-tab="file"
          >
            üìÅ Archivo
          </button>
          <button 
            id="tabMic"
            class="tab-button px-6 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700"
            data-tab="mic"
          >
            üé§ Micr√≥fono
          </button>
        </div>
      </div>

      <!-- File Upload Section -->
      <div id="fileSection" class="mb-8">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Archivo de audio
        </label>
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-400 transition-colors">
          <input 
            type="file" 
            id="audioFile" 
            accept="audio/*,.wav,.mp3,.ogg,.webm"
            class="hidden"
          >
          <label 
            for="audioFile" 
            class="cursor-pointer inline-flex flex-col items-center"
          >
            <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <span class="text-sm text-gray-600" id="fileName">
              Haz clic para seleccionar un archivo de audio
            </span>
            <span class="text-xs text-gray-500 mt-2">
              WAV, MP3, OGG, WebM
            </span>
          </label>
        </div>
      </div>

      <!-- Microphone Section -->
      <div id="micSection" class="hidden mb-8">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Grabar desde micr√≥fono
        </label>
        <div class="border-2 border-gray-300 rounded-lg p-8">
          <!-- Recording Controls -->
          <div class="text-center space-y-4">
            <div id="micPermission" class="text-sm text-gray-600 mb-4">
              <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              </svg>
              Presiona el bot√≥n para comenzar a grabar
            </div>

            <!-- Recording Button -->
            <button 
              id="recordBtn"
              class="inline-flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-8 rounded-full transition-all transform hover:scale-105"
            >
              <span id="recordIcon">‚óè</span>
              <span id="recordText">Grabar</span>
            </button>

            <!-- Duration Slider -->
            <div class="mt-6">
              <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">
                Duraci√≥n: <span id="durationValue">3</span> segundos
              </label>
              <input 
                type="range" 
                id="duration" 
                min="1" 
                max="10" 
                value="3" 
                class="w-full"
              >
            </div>

            <!-- Recording Status -->
            <div id="recordingStatus" class="hidden">
              <div class="flex items-center justify-center gap-2 text-red-600">
                <span class="inline-block w-3 h-3 bg-red-600 rounded-full animate-pulse"></span>
                <span class="font-medium">Grabando... <span id="recordingTime">0</span>s</span>
              </div>
            </div>

            <!-- Audio Preview -->
            <div id="audioPreview" class="hidden mt-4">
              <p class="text-sm text-green-600 font-medium mb-2">‚úì Audio grabado</p>
              <audio id="audioPlayer" controls class="w-full"></audio>
            </div>
          </div>
        </div>
      </div>

      <!-- Language Selector -->
      <div class="mb-6">
        <label for="language" class="block text-sm font-medium text-gray-700 mb-2">
          Idioma
        </label>
        <select 
          id="language" 
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        >
          <option value="es">Espa√±ol</option>
          <option value="en">Ingl√©s</option>
          <option value="es-mx">Espa√±ol (M√©xico)</option>
          <option value="en-us">Ingl√©s (Estados Unidos)</option>
        </select>
      </div>

      <!-- Submit Button -->
      <button 
        id="transcribeBtn"
        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
      >
        Transcribir
      </button>

      <!-- Loading Indicator -->
      <div id="loading" class="hidden mt-6 text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
        <p class="text-gray-600 mt-2">Transcribiendo audio...</p>
      </div>

      <!-- Error Message -->
      <div id="error" class="hidden mt-6 bg-red-50 border-l-4 border-red-500 p-4 rounded">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
          <p id="errorMessage" class="text-red-700 font-medium"></p>
        </div>
      </div>

      <!-- Results Section -->
      <div id="results" class="hidden mt-8 space-y-6">
        <!-- IPA Transcription -->
        <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-6">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-semibold text-gray-800">Transcripci√≥n IPA</h3>
            <button 
              id="copyBtn"
              class="text-sm text-purple-600 hover:text-purple-800 flex items-center gap-1"
              title="Copiar al portapapeles"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              Copiar
            </button>
          </div>
          <p id="ipaText" class="text-2xl font-mono text-purple-900"></p>
        </div>

        <!-- Tokens -->
        <div>
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Tokens individuales</h3>
          <div id="tokens" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Metadata -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="text-sm font-semibold text-gray-700 mb-2">Metadatos</h3>
          <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
            <dt class="text-gray-600">Backend:</dt>
            <dd id="metaBackend" class="text-gray-900 font-medium"></dd>
            <dt class="text-gray-600">M√©todo:</dt>
            <dd id="metaMethod" class="text-gray-900 font-medium"></dd>
            <dt class="text-gray-600">Tokens:</dt>
            <dd id="metaTokens" class="text-gray-900 font-medium"></dd>
          </dl>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center mt-12 text-gray-600 text-sm">
      <p>
        PronunciaPA - Sistema de an√°lisis fon√©tico
        <a href="index.html" class="text-purple-600 hover:text-purple-800 ml-2">‚Üê Volver al inicio</a>
      </p>
    </footer>
  </div>

  <script type="module">
    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:8000' 
      : window.PRONUNCIAPA_API_BASE || 'http://localhost:8000';

    const USER_ID_KEY = 'pronunciapa_user_id';
    function getUserId() {
      try {
        const stored = localStorage.getItem(USER_ID_KEY);
        if (stored) return stored;
      } catch (_err) {
        // noop
      }
      const generated = (window.crypto && window.crypto.randomUUID)
        ? window.crypto.randomUUID()
        : `user_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
      try {
        localStorage.setItem(USER_ID_KEY, generated);
      } catch (_err) {
        // noop
      }
      return generated;
    }

    const userId = getUserId();

    const elements = {
      // Tabs
      tabFile: document.getElementById('tabFile'),
      tabMic: document.getElementById('tabMic'),
      fileSection: document.getElementById('fileSection'),
      micSection: document.getElementById('micSection'),
      
      // File upload
      audioFile: document.getElementById('audioFile'),
      fileName: document.getElementById('fileName'),
      
      // Microphone
      recordBtn: document.getElementById('recordBtn'),
      recordIcon: document.getElementById('recordIcon'),
      recordText: document.getElementById('recordText'),
      duration: document.getElementById('duration'),
      durationValue: document.getElementById('durationValue'),
      recordingStatus: document.getElementById('recordingStatus'),
      recordingTime: document.getElementById('recordingTime'),
      audioPreview: document.getElementById('audioPreview'),
      audioPlayer: document.getElementById('audioPlayer'),
      micPermission: document.getElementById('micPermission'),
      
      // Common
      language: document.getElementById('language'),
      transcribeBtn: document.getElementById('transcribeBtn'),
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      errorMessage: document.getElementById('errorMessage'),
      results: document.getElementById('results'),
      ipaText: document.getElementById('ipaText'),
      tokens: document.getElementById('tokens'),
      copyBtn: document.getElementById('copyBtn'),
      metaBackend: document.getElementById('metaBackend'),
      metaMethod: document.getElementById('metaMethod'),
      metaTokens: document.getElementById('metaTokens'),
    };

    let selectedFile = null;
    let recordedBlob = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingInterval = null;
    let currentTab = 'file';

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        switchTab(tab);
      });
    });

    function switchTab(tab) {
      currentTab = tab;
      
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        if (btn.dataset.tab === tab) {
          btn.classList.add('border-purple-600', 'text-purple-600');
          btn.classList.remove('border-transparent', 'text-gray-500');
        } else {
          btn.classList.remove('border-purple-600', 'text-purple-600');
          btn.classList.add('border-transparent', 'text-gray-500');
        }
      });

      // Show/hide sections
      if (tab === 'file') {
        elements.fileSection.classList.remove('hidden');
        elements.micSection.classList.add('hidden');
        elements.transcribeBtn.disabled = !selectedFile;
      } else {
        elements.fileSection.classList.add('hidden');
        elements.micSection.classList.remove('hidden');
        elements.transcribeBtn.disabled = !recordedBlob;
      }

      // Clear previous results
      elements.error.classList.add('hidden');
      elements.results.classList.add('hidden');
    }

    // File selection handler
    elements.audioFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        elements.fileName.textContent = file.name;
        elements.transcribeBtn.disabled = false;
        elements.error.classList.add('hidden');
        elements.results.classList.add('hidden');
      }
    });

    // Duration slider
    elements.duration.addEventListener('input', (e) => {
      elements.durationValue.textContent = e.target.value;
    });

    // Microphone recording
    elements.recordBtn.addEventListener('click', async () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        stopRecording();
      } else {
        await startRecording();
      }
    });

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 16000
          } 
        });

        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream, {
          mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg'
        });

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          recordedBlob = await convertToWav(blob);
          
          // Show preview
          const url = URL.createObjectURL(recordedBlob);
          elements.audioPlayer.src = url;
          elements.audioPreview.classList.remove('hidden');
          elements.transcribeBtn.disabled = false;
          
          // Stop all tracks
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        
        // Update UI
        elements.recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
        elements.recordBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        elements.recordIcon.textContent = '‚ñ†';
        elements.recordText.textContent = 'Detener';
        elements.recordingStatus.classList.remove('hidden');
        elements.audioPreview.classList.add('hidden');
        elements.recordBtn.disabled = false;

        // Auto-stop after duration
        const duration = parseInt(elements.duration.value) * 1000;
        let elapsed = 0;
        recordingInterval = setInterval(() => {
          elapsed += 100;
          elements.recordingTime.textContent = (elapsed / 1000).toFixed(1);
          
          if (elapsed >= duration) {
            stopRecording();
          }
        }, 100);

      } catch (err) {
        console.error('Error accessing microphone:', err);
        showError('No se pudo acceder al micr√≥fono. Verifica los permisos del navegador.');
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        
        // Clear interval
        if (recordingInterval) {
          clearInterval(recordingInterval);
          recordingInterval = null;
        }

        // Reset UI
        elements.recordBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
        elements.recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
        elements.recordIcon.textContent = '‚óè';
        elements.recordText.textContent = 'Grabar';
        elements.recordingStatus.classList.add('hidden');
        elements.recordingTime.textContent = '0';
      }
    }

    // Convert WebM/OGG to WAV (simplified - works with most browsers)
    async function convertToWav(blob) {
      // For now, we'll just return the original blob
      // The server should handle WebM/OGG conversion
      // If you need true WAV conversion, you'd need to use Web Audio API
      return blob;
    }

    // Copy to clipboard
    elements.copyBtn.addEventListener('click', async () => {
      const text = elements.ipaText.textContent;
      try {
        await navigator.clipboard.writeText(text);
        const originalText = elements.copyBtn.innerHTML;
        elements.copyBtn.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>¬°Copiado!';
        setTimeout(() => {
          elements.copyBtn.innerHTML = originalText;
        }, 2000);
      } catch (err) {
        console.error('Error al copiar:', err);
      }
    });

    // Transcribe button handler
    elements.transcribeBtn.addEventListener('click', async () => {
      const audioSource = currentTab === 'file' ? selectedFile : recordedBlob;
      
      if (!audioSource) return;

      // Hide previous results/errors
      elements.error.classList.add('hidden');
      elements.results.classList.add('hidden');
      elements.loading.classList.remove('hidden');
      elements.transcribeBtn.disabled = true;

      try {
        const formData = new FormData();
        
        if (currentTab === 'file') {
          formData.append('audio', selectedFile);
        } else {
          // Create a file from blob with proper name
          const filename = `recording_${Date.now()}.webm`;
          const file = new File([recordedBlob], filename, { type: recordedBlob.type });
          formData.append('audio', file);
        }
        
        formData.append('lang', elements.language.value);
        if (userId) {
          formData.append('user_id', userId);
        }

        const response = await fetch(`${API_BASE}/v1/transcribe`, {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.detail || `Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        displayResults(data);
      } catch (err) {
        showError(err.message || 'Error al conectar con el servidor. Verifica que est√© corriendo en ' + API_BASE);
      } finally {
        elements.loading.classList.add('hidden');
        elements.transcribeBtn.disabled = false;
      }
    });

    function displayResults(data) {
      // IPA text
      elements.ipaText.textContent = data.ipa || '‚Äî';

      // Tokens
      elements.tokens.innerHTML = '';
      if (data.tokens && data.tokens.length > 0) {
        data.tokens.forEach(token => {
          const span = document.createElement('span');
          span.textContent = token;
          span.className = 'px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-mono';
          elements.tokens.appendChild(span);
        });
      } else {
        elements.tokens.textContent = 'No hay tokens';
      }

      // Metadata
      elements.metaBackend.textContent = data.meta?.backend || '‚Äî';
      elements.metaMethod.textContent = data.meta?.method || '‚Äî';
      elements.metaTokens.textContent = data.tokens?.length || 0;

      // Show results
      elements.results.classList.remove('hidden');
    }

    function showError(message) {
      elements.errorMessage.textContent = message;
      elements.error.classList.remove('hidden');
    }
  </script>
</body>
</html>
